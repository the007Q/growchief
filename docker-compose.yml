services:
  # -----------------------
  # Growchief Application
  # -----------------------
  growchief:
    build: .  # BUILD FROM YOUR FORK instead of using broken image
    container_name: growchief
    restart: always
    environment:
      DATABASE_URL: postgresql://${GROWCHIEF_POSTGRES_USER}:${GROWCHIEF_POSTGRES_PASSWORD}@growchief-postgres:5432/${GROWCHIEF_POSTGRES_DB}
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-local}
      UPLOAD_DIRECTORY: ${UPLOAD_DIRECTORY:-/uploads}
      NEXT_PUBLIC_UPLOAD_DIRECTORY: ${NEXT_PUBLIC_UPLOAD_DIRECTORY:-/uploads}
      AUTH_SECRET: ${AUTH_SECRET}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      TEMPORAL_ADDRESS: ${TEMPORAL_ADDRESS:-temporal:7233}
      APOLLO_API_KEY: ${APOLLO_API_KEY:-}
      DATAGMA_API_KEY: ${DATAGMA_API_KEY:-}
    volumes:
      - growchief-config:/config/
      - growchief-uploads:/uploads/
    networks:
      - growchief-network
      - temporal-network
    depends_on:
      growchief-postgres:
        condition: service_healthy
    labels:
      - traefik.enable=true
      - traefik.http.routers.growchief.rule=Host(`growchief.quontumm.com`)
      - traefik.http.routers.growchief.entrypoints=https
      - traefik.http.routers.growchief.tls=true
      - traefik.http.services.growchief.loadbalancer.server.port=5000

  growchief-postgres:
    image: postgres:16
    container_name: growchief-postgres
    restart: always
    environment:
      POSTGRES_PASSWORD: ${GROWCHIEF_POSTGRES_PASSWORD}
      POSTGRES_USER: ${GROWCHIEF_POSTGRES_USER}
      POSTGRES_DB: ${GROWCHIEF_POSTGRES_DB}
    volumes:
      - postgres-volume:/var/lib/postgresql/data
    networks:
      - growchief-network
    healthcheck:
      test: pg_isready -U ${GROWCHIEF_POSTGRES_USER} -d ${GROWCHIEF_POSTGRES_DB}
      interval: 10s
      timeout: 3s
      retries: 3

  # -----------------------
  # Temporal Stack
  # -----------------------
  temporal-elasticsearch:
    container_name: temporal-elasticsearch
    image: elasticsearch:7.17.27
    environment:
      - cluster.routing.allocation.disk.threshold_enabled=true
      - cluster.routing.allocation.disk.watermark.low=512mb
      - cluster.routing.allocation.disk.watermark.high=256mb
      - cluster.routing.allocation.disk.watermark.flood_stage=128mb
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
      - xpack.security.enabled=false
    networks:
      - temporal-network
    expose:
      - 9200
    volumes:
      - elasticsearch-data:/var/lib/elasticsearch/data

  temporal-postgresql:
    container_name: temporal-postgresql
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: ${TEMPORAL_POSTGRES_PASSWORD}
      POSTGRES_USER: ${TEMPORAL_POSTGRES_USER}
    networks:
      - temporal-network
    expose:
      - 5432
    volumes:
      - temporal-postgres-data:/var/lib/postgresql/data

  temporal:
    container_name: temporal
    image: temporalio/auto-setup:1.28.1
    depends_on:
      - temporal-postgresql
      - temporal-elasticsearch
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=${TEMPORAL_POSTGRES_USER}
      - POSTGRES_PWD=${TEMPORAL_POSTGRES_PASSWORD}
      - POSTGRES_SEEDS=temporal-postgresql
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-sql.yaml
      - ENABLE_ES=true
      - ES_SEEDS=temporal-elasticsearch
      - ES_VERSION=v7
      - TEMPORAL_NAMESPACE=default
    networks:
      - temporal-network
    expose:
      - 7233

  temporal-ui:
    container_name: temporal-ui
    image: temporalio/ui:2.34.0
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=https://growchief.quontumm.com
    networks:
      - temporal-network
    depends_on:
      - temporal
    labels:
      - traefik.enable=true
      - traefik.http.routers.temporal-ui.rule=Host(`temporal.quontumm.com`)
      - traefik.http.routers.temporal-ui.entrypoints=https
      - traefik.http.routers.temporal-ui.tls=true
      - traefik.http.services.temporal-ui.loadbalancer.server.port=8080

# -----------------------
# Volumes
# -----------------------
volumes:
  postgres-volume:
    external: false
  growchief-config:
    external: false
  growchief-uploads:
    external: false
  elasticsearch-data:
    external: false
  temporal-postgres-data:
    external: false

# -----------------------
# Networks
# -----------------------
networks:
  growchief-network:
    external: false
  temporal-network:
    driver: bridge
```
